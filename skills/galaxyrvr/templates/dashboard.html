<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ GalaxyRVR Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .card h2 {
            margin-bottom: 15px;
            font-size: 1.3em;
            color: #667eea;
        }
        
        .status-grid {
            display: grid;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #0f1626;
            border-radius: 8px;
        }
        
        .status-value {
            font-weight: bold;
            color: #4ade80;
        }
        
        .status-value.warning { color: #fbbf24; }
        .status-value.critical { color: #ef4444; }
        
        #camera-feed {
            width: 100%;
            border-radius: 8px;
            background: #0f1626;
            min-height: 200px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            background: #667eea;
            color: white;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-stop {
            background: #ef4444;
            grid-column: span 3;
        }
        
        .btn-stop:hover {
            background: #dc2626;
        }
        
        #map-canvas {
            width: 100%;
            height: 400px;
            background: #0f1626;
            border-radius: 8px;
            border: 2px solid #667eea;
        }
        
        .map-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .map-item {
            padding: 10px;
            background: #0f1626;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .map-item:hover {
            background: #1a2332;
        }
        
        .map-item-title {
            font-weight: bold;
            color: #667eea;
        }
        
        .map-item-stats {
            font-size: 0.9em;
            color: #888;
            margin-top: 5px;
        }
        
        .slider-container {
            margin-top: 15px;
        }
        
        .slider {
            width: 100%;
            margin-top: 10px;
        }
        
        .refresh-btn {
            padding: 8px 15px;
            background: #0f1626;
            border: 1px solid #667eea;
            border-radius: 6px;
            color: #667eea;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .refresh-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ GalaxyRVR Dashboard</h1>
        
        <div class="grid">
            <!-- Status Card -->
            <div class="card">
                <h2>üìä Status</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <span>Connection</span>
                        <span class="status-value" id="status-connection">Checking...</span>
                    </div>
                    <div class="status-item">
                        <span>Battery</span>
                        <span class="status-value" id="status-battery">--</span>
                    </div>
                    <div class="status-item">
                        <span>Distance</span>
                        <span class="status-value" id="status-distance">--</span>
                    </div>
                    <div class="status-item">
                        <span>WiFi Signal</span>
                        <span class="status-value" id="status-wifi">--</span>
                    </div>
                    <div class="status-item">
                        <span>IR Sensors</span>
                        <span class="status-value" id="status-ir">--</span>
                    </div>
                </div>
                <button class="refresh-btn" onclick="updateStatus()">üîÑ Refresh</button>
            </div>
            
            <!-- Camera Card -->
            <div class="card">
                <h2>üì∑ Camera</h2>
                <img id="camera-feed" src="/api/camera/snapshot" alt="Camera feed">
                <div class="slider-container">
                    <label>Camera Angle: <span id="servo-angle">90</span>¬∞</label>
                    <input type="range" class="slider" id="servo-slider" 
                           min="0" max="180" value="90" 
                           oninput="updateServo(this.value)">
                </div>
                <button class="refresh-btn" onclick="refreshCamera()" style="margin-top: 10px;">üîÑ Refresh Image</button>
            </div>
            
            <!-- Control Card -->
            <div class="card">
                <h2>üéÆ Controls</h2>
                <div class="controls">
                    <div></div>
                    <button class="btn" onmousedown="sendControl('forward')" onmouseup="sendControl('stop')">‚¨ÜÔ∏è Forward</button>
                    <div></div>
                    
                    <button class="btn" onmousedown="sendControl('left')" onmouseup="sendControl('stop')">‚¨ÖÔ∏è Left</button>
                    <button class="btn" onmousedown="sendControl('backward')" onmouseup="sendControl('stop')">‚¨áÔ∏è Back</button>
                    <button class="btn" onmousedown="sendControl('right')" onmouseup="sendControl('stop')">‚û°Ô∏è Right</button>
                    
                    <button class="btn btn-stop" onclick="sendControl('stop')">‚èπÔ∏è STOP</button>
                </div>
                <div class="slider-container">
                    <label>Speed: <span id="speed-value">50</span>%</label>
                    <input type="range" class="slider" id="speed-slider" 
                           min="20" max="100" value="50" 
                           oninput="document.getElementById('speed-value').textContent = this.value">
                </div>
            </div>
        </div>
        
        <div class="grid">
            <!-- Map Card -->
            <div class="card" style="grid-column: span 2;">
                <h2>üó∫Ô∏è Live Map</h2>
                <canvas id="map-canvas"></canvas>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="refresh-btn" onclick="updateMap()">üîÑ Refresh Map</button>
                    <button class="refresh-btn" onclick="toggleMapView()">üîÑ Toggle View</button>
                    <span id="map-view-mode" style="color: #667eea; margin-left: auto; align-self: center;">Occupancy</span>
                </div>
            </div>
            
            <!-- Saved Maps Card -->
            <div class="card">
                <h2>üíæ Saved Maps</h2>
                <button class="refresh-btn" onclick="loadMapList()">üîÑ Refresh List</button>
                <div class="map-list" id="map-list">
                    Loading...
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const socket = io();
        let currentSpeed = 50;
        let mapViewMode = 'occupancy'; // or 'wifi'
        
        // Auto-refresh camera
        setInterval(refreshCamera, 2000);
        
        // Auto-refresh status
        setInterval(updateStatus, 5000);
        
        // Initial load
        updateStatus();
        loadMapList();
        updateMap();
        
        function refreshCamera() {
            const img = document.getElementById('camera-feed');
            img.src = '/api/camera/snapshot?t=' + Date.now();
        }
        
        function updateStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    if (data.connected) {
                        document.getElementById('status-connection').textContent = '‚úÖ Connected';
                        document.getElementById('status-connection').className = 'status-value';
                        
                        const battery = data.battery;
                        const batteryText = `${battery.voltage.toFixed(2)}V (${battery.percent}%)`;
                        const batteryEl = document.getElementById('status-battery');
                        batteryEl.textContent = batteryText;
                        
                        if (battery.status === 'critical') batteryEl.className = 'status-value critical';
                        else if (battery.status === 'low') batteryEl.className = 'status-value warning';
                        else batteryEl.className = 'status-value';
                        
                        const dist = data.sensors.ultrasonic_cm;
                        document.getElementById('status-distance').textContent = 
                            dist > 0 ? `${dist.toFixed(0)}cm` : 'N/A';
                        
                        document.getElementById('status-wifi').textContent = 
                            `${data.wifi.signal_dbm}dBm (${data.wifi.quality})`;
                        
                        const irLeft = data.sensors.ir_left ? 'üî¥' : '‚úÖ';
                        const irRight = data.sensors.ir_right ? 'üî¥' : '‚úÖ';
                        document.getElementById('status-ir').textContent = `L:${irLeft} R:${irRight}`;
                    } else {
                        document.getElementById('status-connection').textContent = 'üî¥ Offline';
                        document.getElementById('status-connection').className = 'status-value critical';
                    }
                })
                .catch(err => {
                    document.getElementById('status-connection').textContent = 'üî¥ Error';
                    document.getElementById('status-connection').className = 'status-value critical';
                });
        }
        
        function sendControl(command) {
            currentSpeed = document.getElementById('speed-slider').value;
            socket.emit('control', {
                command: command,
                speed: parseInt(currentSpeed)
            });
        }
        
        function updateServo(angle) {
            document.getElementById('servo-angle').textContent = angle;
            socket.emit('control', {
                command: 'servo',
                angle: parseInt(angle)
            });
        }
        
        function updateMap() {
            fetch('/api/maps/current')
                .then(r => r.json())
                .then(data => {
                    drawMap(data);
                })
                .catch(err => console.error('Map update failed:', err));
        }
        
        function toggleMapView() {
            mapViewMode = mapViewMode === 'occupancy' ? 'wifi' : 'occupancy';
            document.getElementById('map-view-mode').textContent = 
                mapViewMode === 'occupancy' ? 'Occupancy' : 'WiFi Heatmap';
            updateMap();
        }
        
        function drawMap(data) {
            const canvas = document.getElementById('map-canvas');
            const ctx = canvas.getContext('2d');
            const grid = data.grid;
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const cellWidth = canvas.width / grid[0].length;
            const cellHeight = canvas.height / grid.length;
            
            // Draw grid
            for (let y = 0; y < grid.length; y++) {
                for (let x = 0; x < grid[y].length; x++) {
                    const cell = grid[y][x];
                    
                    if (mapViewMode === 'occupancy') {
                        // Occupancy view
                        if (cell.occupancy === 0) {
                            ctx.fillStyle = '#1a1a2e'; // Unknown
                        } else if (cell.occupancy < 30) {
                            ctx.fillStyle = '#2d5016'; // Free (green)
                        } else if (cell.occupancy < 60) {
                            ctx.fillStyle = '#3d4016'; // Maybe free
                        } else {
                            ctx.fillStyle = '#5d1616'; // Obstacle (red)
                        }
                    } else {
                        // WiFi heatmap
                        if (cell.wifi === null) {
                            ctx.fillStyle = '#1a1a2e'; // Unknown
                        } else {
                            const signal = cell.wifi;
                            if (signal >= -50) ctx.fillStyle = '#166d16'; // Excellent
                            else if (signal >= -60) ctx.fillStyle = '#4d6d16'; // Good
                            else if (signal >= -70) ctx.fillStyle = '#6d4d16'; // Fair
                            else if (signal >= -80) ctx.fillStyle = '#6d2616'; // Weak
                            else ctx.fillStyle = '#2d1616'; // Very weak
                        }
                    }
                    
                    ctx.fillRect(x * cellWidth, y * cellHeight, cellWidth, cellHeight);
                }
            }
            
            // Draw rover
            const roverGridX = Math.floor(data.rover_position.x / (data.cell_size_cm * 2));
            const roverGridY = Math.floor(data.rover_position.y / (data.cell_size_cm * 2));
            
            ctx.fillStyle = '#667eea';
            ctx.beginPath();
            ctx.arc(
                roverGridX * cellWidth + cellWidth / 2,
                roverGridY * cellHeight + cellHeight / 2,
                Math.min(cellWidth, cellHeight) / 2,
                0, Math.PI * 2
            );
            ctx.fill();
            
            // Draw heading indicator
            const heading = data.rover_position.heading * Math.PI / 180;
            const arrowLen = Math.min(cellWidth, cellHeight);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(
                roverGridX * cellWidth + cellWidth / 2,
                roverGridY * cellHeight + cellHeight / 2
            );
            ctx.lineTo(
                roverGridX * cellWidth + cellWidth / 2 + Math.sin(heading) * arrowLen,
                roverGridY * cellHeight + cellHeight / 2 + Math.cos(heading) * arrowLen
            );
            ctx.stroke();
        }
        
        function loadMapList() {
            fetch('/api/maps/list')
                .then(r => r.json())
                .then(data => {
                    const list = document.getElementById('map-list');
                    if (data.maps.length === 0) {
                        list.innerHTML = '<p style="color: #888; padding: 10px;">No saved maps</p>';
                        return;
                    }
                    
                    list.innerHTML = data.maps.map(map => `
                        <div class="map-item" onclick="loadSpecificMap('${map.filename}')">
                            <div class="map-item-title">${map.timestamp}</div>
                            <div class="map-item-stats">
                                ${map.distance_m.toFixed(1)}m ‚Ä¢ 
                                ${map.explored_pct.toFixed(0)}% explored ‚Ä¢ 
                                ${map.scans} scans
                            </div>
                        </div>
                    `).join('');
                })
                .catch(err => {
                    document.getElementById('map-list').innerHTML = 
                        '<p style="color: #ef4444; padding: 10px;">Error loading maps</p>';
                });
        }
        
        function loadSpecificMap(filename) {
            fetch('/api/maps/load', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filename: filename})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    updateMap();
                    alert('Map loaded!');
                } else {
                    alert('Failed to load map: ' + data.error);
                }
            });
        }
        
        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return; // Don't interfere with inputs
            
            switch(e.key.toLowerCase()) {
                case 'w': sendControl('forward'); break;
                case 's': sendControl('backward'); break;
                case 'a': sendControl('left'); break;
                case 'd': sendControl('right'); break;
                case ' ': sendControl('stop'); e.preventDefault(); break;
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.target.tagName === 'INPUT') return;
            
            if (['w', 's', 'a', 'd'].includes(e.key.toLowerCase())) {
                sendControl('stop');
            }
        });
    </script>
</body>
</html>
